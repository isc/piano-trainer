<!doctype html>
<html lang="fr" x-data="midiApp()">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Piano Trainer</title>
    <link rel="stylesheet" href="vendor/pico.2.1.1min.css" />
    <link rel="stylesheet" href="styles.css" />
    <script type="importmap">
    {
      "imports": {
        "tone": "https://esm.sh/tone@14.8.49",
        "@tonejs/piano": "https://esm.sh/@tonejs/piano@0.2.1?external=tone"
      }
    }
    </script>
    <!-- Load modules before Alpine -->
    <script type="module">
      import { midiApp } from './js/app.js'
      window.midiApp = midiApp
    </script>
    <script src="vendor/jszip.3.10.1.min.js"></script>
    <script src="vendor/opensheetmusicdisplay.1.9.5.min.js"></script>
    <script defer src="vendor/alpinejs.3.14.9.min.js"></script>
  </head>
  <body>
    <main class="container">
      <section class="grid">
        <a href="index.html">&larr; Biblioth√®que</a>
        <button @click="connectMIDI" x-text="'Connecter clavier MIDI'" x-show="!bluetoothConnected"></button>
        <strong x-show="bluetoothConnected"> üéπ <span x-text="midiDeviceName || 'Clavier MIDI'"></span> </strong>
        <button
          @click="toggleTrainingMode"
          x-show="!!osmdInstance"
          x-text="trainingMode ? 'üîÑ Mode Entra√Ænement Actif' : 'üéØ Mode Entra√Ænement'"
          :aria-pressed="trainingMode"
          class="secondary"
        ></button>
        <button
          @click="togglePlayback"
          x-show="!!osmdInstance"
          x-text="isPlaying ? '‚èπ Stop' : '‚ñ∂ √âcouter'"
          class="secondary"
        ></button>
        <button @click="openScoreHistory" x-show="!!scoreUrl" class="secondary">üìú Historique</button>
        <label>
          <input type="checkbox" x-model="rightHandActive" @change="updateActiveHands" />
          Main droite
        </label>
        <label>
          <input type="checkbox" x-model="leftHandActive" @change="updateActiveHands" />
          Main gauche
        </label>
      </section>

      <article x-show="!osmdInstance">
        <label for="musicxml-upload">üìÑ Charger partition MusicXML</label>
        <input type="file" accept=".xml,.musicxml,.mxl" @change="loadMusicXML($event)" id="musicxml-upload" />
      </article>

      <article x-show="trainingComplete" class="success">
        <header>
          <strong>üéâ F√©licitations !</strong>
        </header>
        <p>Vous avez compl√©t√© toutes les mesures du morceau !</p>
        <button @click="toggleTrainingMode">Quitter le mode entra√Ænement</button>
      </article>

      <dialog :open="showScoreCompleteModal">
        <article>
          <header>
            <button aria-label="Close" rel="prev" @click="closeScoreCompleteModal()"></button>
            <p><strong>üéâ Partition termin√©e !</strong></p>
          </header>
          <table x-show="previousPlaythroughs.length > 0">
            <tbody>
              <template x-for="(pt, idx) in previousPlaythroughs" :key="idx">
                <tr>
                  <td>
                    <strong x-show="pt.isCurrent" x-text="formatDuration(pt.durationMs)"></strong>
                    <span x-show="!pt.isCurrent" x-text="formatDuration(pt.durationMs)"></span>
                  </td>
                  <td>
                    <small x-text="pt.isCurrent ? 'maintenant' : formatDate(pt.startedAt)"></small>
                  </td>
                </tr>
              </template>
            </tbody>
          </table>
          <p x-show="currentPlaythroughDuration && previousPlaythroughs.length === 0">
            Temps : <strong x-text="formatDuration(currentPlaythroughDuration)"></strong>
          </p>
        </article>
      </dialog>

      <p x-show="measuresToReinforce.length > 0 && !trainingMode">
        <a href="#" @click.prevent="startReinforcementMode()">Renforcer <span x-text="measuresToReinforce.length"></span> mesure<span x-show="measuresToReinforce.length > 1">s</span></a>
      </p>

      <section id="score" x-show="!!osmdInstance"></section>

      <article x-show="errorMessage != null">
        <div x-show="errorMessage != null" class="error-message" x-text="errorMessage" x-transition></div>
      </article>

      <!-- Gestion des cassettes (hidden when API unavailable, e.g. on GitHub Pages) -->
      <template x-if="cassetteApiAvailable">
        <div>
          <select x-model="selectedCassette" @change="loadCassettesList()" x-show="!isRecording">
            <option value="">Choisir une cassette...</option>
            <template x-for="cassette in cassettes" :key="cassette.name">
              <option :value="cassette.file" x-text="cassette.name"></option>
            </template>
          </select>
          <button @click="replayCassette" x-show="selectedCassette && !isReplaying && !isRecording" class="secondary">
            ‚ñ∂Ô∏è Rejouer cassette
          </button>
          <strong x-show="isReplaying"> ‚ñ∂Ô∏è Rejeu en cours... </strong>
          <strong x-show="replayEnded"> ‚úÖ Rejeu termin√© </strong>

          <!-- Contr√¥les d'enregistrement -->
          <button @click="startRecording" x-show="!isRecording && !isReplaying && bluetoothConnected" class="secondary">
            üî¥ D√©marrer enregistrement
          </button>
          <button @click="stopRecording" x-show="isRecording" class="secondary">‚èπÔ∏è Arr√™ter enregistrement</button>
          <strong x-show="isRecording"> üî¥ Enregistrement en cours... </strong>
        </div>
      </template>
    </main>

    <dialog id="scoreHistoryModal" :open="showHistoryModal">
      <article>
        <header>
          <button aria-label="Close" rel="prev" @click="showHistoryModal = false"></button>
          <p><strong>üìú Historique de pratique</strong></p>
        </header>
        <template x-if="scoreHistory.length === 0">
          <p>Aucun historique pour cette partition.</p>
        </template>
        <template x-for="day in scoreHistory" :key="day.date">
          <div>
            <strong x-text="formatDate(day.date)"></strong>
            <span x-text="' ' + formatDuration(day.totalPracticeTimeMs)"></span>
            <div x-show="day.timesPlayedInFull === 0 && day.measuresWorked.length > 0">
              <small x-text="day.measuresWorked.length + ' mesures jou√©es'"></small>
            </div>
            <div x-show="day.measuresReinforced.length > 0">
              <small x-text="day.measuresReinforced.length + ' mesures renforc√©es'"></small>
            </div>
            <div x-show="day.fullPlaythroughs.length > 0">
              <small x-text="formatPlaythroughs(day.fullPlaythroughs)"></small>
            </div>
          </div>
        </template>
      </article>
    </dialog>

    <dialog id="noMidiModal" x-bind:open="!navigator.requestMIDIAccess">
      <article>
        <header>
          <button aria-label="Close" rel="prev" onclick="noMidiModal.close()"></button>
          <p><strong>Web MIDI non support√©</strong></p>
        </header>
        <p>
          Votre navigateur ne supporte pas Web MIDI API. Essayez avec
          <a href="https://caniuse.com/?search=web%20midi">un autre navigateur</a>
          (Chrome, Edge ou Opera).
        </p>
      </article>
    </dialog>

    <dialog :open="showReinforcementCompleteModal">
      <article>
        <header>
          <button aria-label="Close" rel="prev" @click="showReinforcementCompleteModal = false"></button>
          <p><strong>Renforcement termin√© !</strong></p>
        </header>
        <p>Toutes les mesures ont √©t√© renforc√©es.</p>
      </article>
    </dialog>

    <dialog id="fingeringModal" :open="showFingeringModal" @keydown.escape.prevent="closeFingeringModal()">
      <article>
        <header>
          <button aria-label="Close" rel="prev" @click="closeFingeringModal()"></button>
          <p><strong>Doigt√©</strong></p>
        </header>

        <p x-text="fingeringSequence || '‚Ä¶'" data-testid="fingering-display"></p>
        <div class="grid">
          <template x-for="finger in [1, 2, 3, 4, 5]" :key="finger">
            <button @click="appendFinger(finger)" x-text="finger"></button>
          </template>
          <button @click="removeFingering()" class="secondary outline">√ó</button>
        </div>
        <footer>
          <button @click="validateFingering()">‚úì Valider</button>
        </footer>
      </article>
    </dialog>

    <dialog id="midiHelpModal" :open="showMidiHelpModal">
      <article>
        <header>
          <button aria-label="Close" rel="prev" @click="showMidiHelpModal = false"></button>
          <p><strong>Connexion clavier MIDI</strong></p>
        </header>

        <p>Aucun p√©riph√©rique MIDI d√©tect√©. Voici comment connecter votre clavier :</p>

        <template x-if="detectedOS() === 'mac'">
          <div>
            <h4>macOS</h4>
            <p>Selon votre piano, deux cas de figure :</p>
            <details open>
              <summary><strong>Connexion directe (ex : Roland FP-30)</strong></summary>
              <p>Allumez simplement votre piano. La connexion Bluetooth s'effectue automatiquement. Revenez ensuite sur cette page et cliquez sur ¬´ Connecter clavier MIDI ¬ª.</p>
            </details>
            <details>
              <summary><strong>Via Audio MIDI Setup (ex : Kawai)</strong></summary>
              <ol>
                <li>Ouvrez l'application <strong>Audio MIDI Setup</strong> (Spotlight : ¬´ Audio MIDI ¬ª)</li>
                <li>Allez dans <strong>Fen√™tre ‚Üí Afficher le studio MIDI</strong></li>
                <li>Cliquez sur l'ic√¥ne <strong>Bluetooth</strong></li>
                <li>Rep√©rez votre piano dans la liste et cliquez sur <strong>Connecter</strong></li>
              </ol>
              <p>Revenez ensuite sur cette page et cliquez sur ¬´ Connecter clavier MIDI ¬ª.</p>
            </details>
          </div>
        </template>

        <template x-if="detectedOS() === 'windows'">
          <div>
            <h4>Windows</h4>
            <p>La connexion Bluetooth MIDI sur Windows n√©cessite des logiciels tiers :</p>
            <ol>
              <li>Installez <strong>BLE MIDI Bridge</strong> (pour recevoir le signal Bluetooth MIDI)</li>
              <li>Installez <strong>loopMIDI</strong> (pour cr√©er un port MIDI virtuel)</li>
              <li>Configurez BLE MIDI Bridge pour rediriger vers le port loopMIDI</li>
            </ol>
            <p>Une fois le pont configur√©, revenez sur cette page et cliquez sur ¬´ Connecter clavier MIDI ¬ª.</p>
          </div>
        </template>

        <template x-if="detectedOS() === 'other'">
          <div>
            <h4>Linux</h4>
            <p>Connectez votre clavier MIDI via USB ou configurez la connexion Bluetooth MIDI via BlueZ. Revenez ensuite sur cette page et cliquez sur ¬´ Connecter clavier MIDI ¬ª.</p>
          </div>
        </template>

        <footer>
          <button @click="showMidiHelpModal = false; connectMIDI()">R√©essayer la connexion</button>
        </footer>
      </article>
    </dialog>
  </body>
</html>
