<!doctype html>
<html lang="fr" x-data="midiApp()">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Piano Trainer</title>
    <!-- https://unpkg.com/@picocss/pico@latest/css/pico.min.css -->
    <link rel="stylesheet" href="vendor/pico.2.1.1min.css" />
    <link rel="stylesheet" href="styles.css" />
    <!-- Load modules before Alpine -->
    <script type="module">
      import { midiApp } from './js/app.js'
      window.midiApp = midiApp
    </script>
    <!-- https://cdn.jsdelivr.net/npm/opensheetmusicdisplay@1.8.5/build/opensheetmusicdisplay.min.js -->
    <script src="vendor/opensheetmusicdisplay.1.8.5.min.js"></script>
    <!-- https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js -->
    <script defer src="vendor/alpinejs.3.14.9.min.js"></script>
  </head>
  <body>
    <main class="container">
      <section class="grid">
        <a href="index.html">&larr; BibliothÃ¨que</a>
        <button @click="connectMIDI" x-text="'Connecter clavier MIDI'" x-show="!bluetoothConnected"></button>
        <strong x-show="bluetoothConnected"> ğŸ¹ <span x-text="midiDeviceName || 'Clavier MIDI'"></span> </strong>
        <button
          @click="toggleTrainingMode"
          x-show="!!osmdInstance"
          x-text="trainingMode ? 'ğŸ”„ Mode EntraÃ®nement Actif' : 'ğŸ¯ Mode EntraÃ®nement'"
          :aria-pressed="trainingMode"
          class="secondary"
        ></button>
        <button @click="requestFullscreen" x-show="!!osmdInstance" x-text="'â›¶ Plein Ã©cran'" class="secondary"></button>
        <label>
          <input type="checkbox" x-model="rightHandActive" @change="updateActiveHands" />
          Main droite
        </label>
        <label>
          <input type="checkbox" x-model="leftHandActive" @change="updateActiveHands" />
          Main gauche
        </label>
      </section>

      <article x-show="!osmdInstance">
        <label for="musicxml-upload">ğŸ“„ Charger partition MusicXML</label>
        <input type="file" accept=".xml,.musicxml,.mxl" @change="loadMusicXML($event)" id="musicxml-upload" />
      </article>

      <article x-show="trainingComplete" class="success">
        <header>
          <strong>ğŸ‰ FÃ©licitations !</strong>
        </header>
        <p>Vous avez complÃ©tÃ© toutes les mesures du morceau !</p>
        <button @click="toggleTrainingMode">Quitter le mode entraÃ®nement</button>
      </article>

      <dialog :open="showScoreCompleteModal">
        <article class="success">
          <header>
            <strong>ğŸ‰ FÃ©licitations !</strong>
          </header>
          <p>Partition terminÃ©e !</p>
        </article>
      </dialog>

      <section id="score" x-show="!!osmdInstance"></section>

      <article x-show="errorMessage != null">
        <div x-show="errorMessage != null" class="error-message" x-text="errorMessage" x-transition></div>
      </article>

      <!-- Gestion des cassettes -->
      <select x-model="selectedCassette" @change="loadCassettesList()" x-show="!isRecording">
        <option value="">Choisir une cassette...</option>
        <template x-for="cassette in cassettes" :key="cassette.name">
          <option :value="cassette.file" x-text="cassette.name"></option>
        </template>
      </select>
      <button @click="replayCassette" x-show="selectedCassette && !isReplaying && !isRecording" class="secondary">
        â–¶ï¸ Rejouer cassette
      </button>
      <strong x-show="isReplaying"> â–¶ï¸ Rejeu en cours... </strong>
      <strong x-show="replayEnded"> âœ… Rejeu terminÃ© </strong>

      <!-- ContrÃ´les d'enregistrement -->
      <button @click="startRecording" x-show="!isRecording && !isReplaying && bluetoothConnected" class="secondary">
        ğŸ”´ DÃ©marrer enregistrement
      </button>
      <button @click="stopRecording" x-show="isRecording" class="secondary">â¹ï¸ ArrÃªter enregistrement</button>
      <strong x-show="isRecording"> ğŸ”´ Enregistrement en cours... </strong>
    </main>

    <dialog id="noMidiModal" x-bind:open="!navigator.requestMIDIAccess">
      <article>
        <header>
          <button aria-label="Close" rel="prev" onclick="noMidiModal.close()"></button>
          <p><strong>Web MIDI non supportÃ©</strong></p>
        </header>
        <p>
          Votre navigateur ne supporte pas Web MIDI API. Essayez avec
          <a href="https://caniuse.com/?search=web%20midi">un autre navigateur</a>
          (Chrome, Edge ou Opera).
        </p>
      </article>
    </dialog>
  </body>
</html>
