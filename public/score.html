<!doctype html>
<html lang="fr" x-data="midiApp()">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Piano Trainer</title>
    <link rel="stylesheet" href="vendor/pico.2.1.1min.css" />
    <link rel="stylesheet" href="styles.css" />
    <!-- Load modules before Alpine -->
    <script type="module">
      import { midiApp } from './js/app.js'
      window.midiApp = midiApp
    </script>
    <script src="vendor/jszip.3.10.1.min.js"></script>
    <script src="vendor/opensheetmusicdisplay.1.8.5.min.js"></script>
    <script defer src="vendor/alpinejs.3.14.9.min.js"></script>
  </head>
  <body>
    <main class="container">
      <section class="grid">
        <a href="index.html">&larr; BibliothÃ¨que</a>
        <button @click="connectMIDI" x-text="'Connecter clavier MIDI'" x-show="!bluetoothConnected"></button>
        <strong x-show="bluetoothConnected"> ğŸ¹ <span x-text="midiDeviceName || 'Clavier MIDI'"></span> </strong>
        <button
          @click="toggleTrainingMode"
          x-show="!!osmdInstance"
          x-text="trainingMode ? 'ğŸ”„ Mode EntraÃ®nement Actif' : 'ğŸ¯ Mode EntraÃ®nement'"
          :aria-pressed="trainingMode"
          class="secondary"
        ></button>
        <button @click="requestFullscreen" x-show="!!osmdInstance" x-text="'â›¶ Plein Ã©cran'" class="secondary"></button>
        <button @click="openScoreHistory" x-show="!!scoreUrl" class="secondary">ğŸ“œ Historique</button>
        <label>
          <input type="checkbox" x-model="rightHandActive" @change="updateActiveHands" />
          Main droite
        </label>
        <label>
          <input type="checkbox" x-model="leftHandActive" @change="updateActiveHands" />
          Main gauche
        </label>
      </section>

      <article x-show="!osmdInstance">
        <label for="musicxml-upload">ğŸ“„ Charger partition MusicXML</label>
        <input type="file" accept=".xml,.musicxml,.mxl" @change="loadMusicXML($event)" id="musicxml-upload" />
      </article>

      <article x-show="trainingComplete" class="success">
        <header>
          <strong>ğŸ‰ FÃ©licitations !</strong>
        </header>
        <p>Vous avez complÃ©tÃ© toutes les mesures du morceau !</p>
        <button @click="toggleTrainingMode">Quitter le mode entraÃ®nement</button>
      </article>

      <dialog :open="showScoreCompleteModal">
        <article>
          <header>
            <button aria-label="Close" rel="prev" @click="closeScoreCompleteModal()"></button>
            <p><strong>ğŸ‰ Partition terminÃ©e !</strong></p>
          </header>
          <table x-show="previousPlaythroughs.length > 0">
            <tbody>
              <template x-for="(pt, idx) in previousPlaythroughs" :key="idx">
                <tr>
                  <td>
                    <strong x-show="pt.isCurrent" x-text="formatDuration(pt.durationMs)"></strong>
                    <span x-show="!pt.isCurrent" x-text="formatDuration(pt.durationMs)"></span>
                  </td>
                  <td>
                    <small x-text="pt.isCurrent ? 'maintenant' : formatDate(pt.startedAt)"></small>
                  </td>
                </tr>
              </template>
            </tbody>
          </table>
          <p x-show="currentPlaythroughDuration && previousPlaythroughs.length === 0">
            Temps : <strong x-text="formatDuration(currentPlaythroughDuration)"></strong>
          </p>
        </article>
      </dialog>

      <article x-show="measuresToReinforce.length > 0 && !trainingMode" class="reinforcement-suggestions">
        <p><strong>Mesures Ã  renforcer</strong> (dernier playthrough)</p>
        <ul>
          <template x-for="measure in measuresToReinforce" :key="measure.sourceMeasureIndex">
            <li>
              Mesure <span x-text="measure.sourceMeasureIndex + 1"></span>
              <small x-text="'(' + measure.wrongNotes + ' erreur' + (measure.wrongNotes > 1 ? 's' : '') + ')'"></small>
            </li>
          </template>
        </ul>
        <button @click="startReinforcementMode()" class="secondary">
          Renforcer ces mesures
        </button>
      </article>

      <section id="score" x-show="!!osmdInstance"></section>

      <article x-show="errorMessage != null">
        <div x-show="errorMessage != null" class="error-message" x-text="errorMessage" x-transition></div>
      </article>

      <!-- Gestion des cassettes (hidden when API unavailable, e.g. on GitHub Pages) -->
      <template x-if="cassetteApiAvailable">
        <div>
          <select x-model="selectedCassette" @change="loadCassettesList()" x-show="!isRecording">
            <option value="">Choisir une cassette...</option>
            <template x-for="cassette in cassettes" :key="cassette.name">
              <option :value="cassette.file" x-text="cassette.name"></option>
            </template>
          </select>
          <button @click="replayCassette" x-show="selectedCassette && !isReplaying && !isRecording" class="secondary">
            â–¶ï¸ Rejouer cassette
          </button>
          <strong x-show="isReplaying"> â–¶ï¸ Rejeu en cours... </strong>
          <strong x-show="replayEnded"> âœ… Rejeu terminÃ© </strong>

          <!-- ContrÃ´les d'enregistrement -->
          <button @click="startRecording" x-show="!isRecording && !isReplaying && bluetoothConnected" class="secondary">
            ğŸ”´ DÃ©marrer enregistrement
          </button>
          <button @click="stopRecording" x-show="isRecording" class="secondary">â¹ï¸ ArrÃªter enregistrement</button>
          <strong x-show="isRecording"> ğŸ”´ Enregistrement en cours... </strong>
        </div>
      </template>
    </main>

    <dialog id="scoreHistoryModal" :open="showHistoryModal">
      <article>
        <header>
          <button aria-label="Close" rel="prev" @click="showHistoryModal = false"></button>
          <p><strong>ğŸ“œ Historique de pratique</strong></p>
        </header>
        <template x-if="scoreHistory.length === 0">
          <p>Aucun historique pour cette partition.</p>
        </template>
        <template x-for="day in scoreHistory" :key="day.date">
          <div>
            <strong x-text="formatDate(day.date)"></strong>
            <span x-text="' ' + formatDuration(day.totalPracticeTimeMs)"></span>
            <div x-show="day.timesPlayedInFull === 0 && day.measuresWorked.length > 0">
              <small x-text="day.measuresWorked.length + ' mesures jouÃ©es'"></small>
            </div>
            <div x-show="day.measuresReinforced.length > 0">
              <small x-text="day.measuresReinforced.length + ' mesures renforcÃ©es'"></small>
            </div>
            <div x-show="day.fullPlaythroughs.length > 0">
              <small x-text="formatPlaythroughs(day.fullPlaythroughs)"></small>
            </div>
          </div>
        </template>
      </article>
    </dialog>

    <dialog id="noMidiModal" x-bind:open="!navigator.requestMIDIAccess">
      <article>
        <header>
          <button aria-label="Close" rel="prev" onclick="noMidiModal.close()"></button>
          <p><strong>Web MIDI non supportÃ©</strong></p>
        </header>
        <p>
          Votre navigateur ne supporte pas Web MIDI API. Essayez avec
          <a href="https://caniuse.com/?search=web%20midi">un autre navigateur</a>
          (Chrome, Edge ou Opera).
        </p>
      </article>
    </dialog>

    <dialog :open="showReinforcementCompleteModal">
      <article>
        <header>
          <button aria-label="Close" rel="prev" @click="showReinforcementCompleteModal = false"></button>
          <p><strong>Renforcement terminÃ© !</strong></p>
        </header>
        <p>Toutes les mesures ont Ã©tÃ© renforcÃ©es.</p>
      </article>
    </dialog>

    <dialog id="fingeringModal" :open="showFingeringModal">
      <article>
        <header>
          <button aria-label="Close" rel="prev" @click="closeFingeringModal()"></button>
          <p><strong>DoigtÃ©</strong></p>
        </header>

        <div class="grid">
          <template x-for="finger in [1, 2, 3, 4, 5]" :key="finger">
            <button @click="selectFingering(finger)" x-text="finger"></button>
          </template>
          <button @click="removeFingering()" class="secondary outline">Ã—</button>
        </div>
      </article>
    </dialog>
  </body>
</html>
